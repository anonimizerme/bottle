<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Playground</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
</head>
<body>

<script>
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
        type = "canvas";
    }

    PIXI.utils.sayHello(type);

    //Create a Pixi Application
    let app = new PIXI.Application({
        width: 600,
        height: 600,
        antialias: true,    // default: false
        transparent: false, // default: false
        resolution: 1       // default: 1
    });
    app.renderer.backgroundColor = 0x061639;

    const playersCount = 4;
    const loader = PIXI.Loader.shared;
    for (let i=0; i < playersCount; i++) {
        loader.add(`player_${i}`, `assets/${i}.svg`)
    }

    let playersImages = {};
    let margin = 40;
    let positionMatrix = [
        {x: app => app.screen.width/2, y: app => margin},
        {x: app => app.screen.width - margin, y: app => app.screen.height/2},
        {x: app => app.screen.width/2, y: app => app.screen.height - margin},
        {x: app => margin, y: app => app.screen.height/2},
    ];
    loader.load((loader, resources) => {
        for (let i=0; i < playersCount; i++) {
            console.log(resources);
            const sprite = new PIXI.Sprite(resources[`player_${i}`].texture);
            sprite.anchor.set(0.5);
            sprite.scale.set(0.3);
            sprite.x = positionMatrix[i].x(app);
            sprite.y = positionMatrix[i].y(app);

            playersImages[`player_${i}`] = sprite;
            app.stage.addChild(playersImages[`player_${i}`]);
        }

        setup();
    });

    let bottle = PIXI.Sprite.from('assets/bottle.png');
    bottle.anchor.set(0.5);
    bottle.scale.set(0.3);
    bottle.x = app.screen.width/2;
    bottle.y = app.screen.height/2;

    app.stage.addChild(bottle);

    //Add the canvas that Pixi automatically created for you to the HTML document
    document.body.appendChild(app.view);

    function setup() {
        let targetAngle = 360*3 + [0, 90, 180, 270][Math.floor(Math.random() * 4)];
        let maxSpeed = 0;
        let speed = 0;
        let distancetoStop = Math.max(180+Math.random()*90);
        app.ticker.add(delta => {
            // increasing speed
            if (bottle.angle <= 180) {
                speed += 0.15;
            } else if (bottle.angle >= targetAngle) {
                speed = 0;
                bottle.angle = targetAngle;
                return;
            } else if (targetAngle - bottle.angle < distancetoStop) {
                maxSpeed = Math.max(maxSpeed, speed);

                const percent = (bottle.angle - (targetAngle - distancetoStop)) / (distancetoStop / 100);
                let percentInvert = 100 - percent;
                speed = (maxSpeed / 100) * Math.max(percentInvert, 8);
            }

            bottle.angle += delta * speed;
        });
    }

    // setup();
</script>
</body>
</html>